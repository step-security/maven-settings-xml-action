name: "build-test"

on: # rebuild any PRs and main branch changes
  pull_request:
  push:
    branches:
      - main

jobs:

  build: # make sure build/ci work properly
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: |
          npm ci
          npm test

  test-basic:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./
        with:
          servers: '[{"id": "foo", "username": "fu", "password": "bar" }]'
          mirrors: '[{ "id": "nexus", "mirrorOf": "!my-org-snapshots,*", "url": "http://redacted/nexus/content/groups/public" }]'
          repositories: '[{"id": "foo", "url": "https://fu.bar"}]'
          plugin_repositories: '[{"id": "foo-plugin", "url": "https://fu.bar.plugin"}]'
          profiles: '[{ "id": "foo.profile", "name": "foo.profile", "url": "http://foo.bar.profile", "properties": { "foo": "property-1", "bar": "property-2"} }]'
          plugin_groups: '[ "some.plugin.group.id", "some.other.plugin.group.id" ]'
          active_profiles: '[ "foo.profile" ]'
      - run: |
          cat ~/.m2/settings.xml

  test-expanded:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./
        with:
          repositories: >
            [
              {
                "id": "some-repository",
                "name": "some-repository-name",
                "url": "http://some.repository.url",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "false"
                }
              }
            ]
          plugin_repositories: >
            [
              {
                "id": "some-plugin-repository",
                "name": "some-plugin-repository-name",
                "url": "http://some.plugin.repository.url",
                "releases": {
                  "enabled": "true"
                },
                "snapshots": {
                  "enabled": "false"
                }
              }
            ]
          servers: >
            [
              {
                "id": "some-id",
                "username": "${env.USER}",
                "password": "${env.PASS}",
                "configuration": {
                  "httpConfiguration": {
                    "all": {
                      "usePreemptive": "true"
                    }
                  }
                }
              }
            ]
          mirrors: >
            [
              {
                "id": "nexus",
                "mirrorOf": "!my-org-snapshots,*",
                "url": "http://redacted/nexus/content/groups/public"
              }
            ]
          profiles: >
            [
              {
                "id": "foo.profile",
                "name": "foo.profile",
                "url": "http://foo.bar.profile",
                "properties": {
                  "foo": "property-1",
                  "bar": "property-2"
                }
              }
            ]
          plugin_groups: >
            [
              "some.plugin.group.id",
              "some.other.plugin.group.id"
            ]
          active_profiles: >
            [
              "some-profile"
            ]
          output_file: .m2/settings.xml
      - run: |
          cat .m2/settings.xml

  test-filepath:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./
        with:
          output_file: custom.xml
      - run: |
          cat custom.xml

  test-maven:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./
        with:
          output_file: custom.xml
      - run: |
          cat custom.xml
      - uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 11
          distribution: 'adopt'
      - run: |
          cd test/maven;
          ./mvnw -s ../../custom.xml clean test

  test-env-filepath:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: ./
        with:
          output_file: $GITHUB_WORKSPACE/custom.xml
      - run: |
          cat $GITHUB_WORKSPACE/custom.xml
      - uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: 11
          distribution: 'adopt'
      - run: |
          cd test/maven;
          ./mvnw -s $GITHUB_WORKSPACE/custom.xml clean test
